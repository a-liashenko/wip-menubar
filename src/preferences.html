<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self'; script-src 'unsafe-inline'">
  <link rel="stylesheet" href="./assets/css/bulma.min.css">
  <link rel="stylesheet" href="./assets/css/style.css">
  <title>Preferences</title>
</head>

<body>

  <header>

      <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <div class="navbar-item">
            <img src="./icons/streaker-icon.png" alt="Streaker Logo">
          </div>
          <div class="navbar-item">
            <span>Streaker</span>
          </div>
        </div>
      </nav>

  </header>

  <main>

    <nav class="panel">
      <p class="panel-heading">
        GitHub Username
      </p>
      <div class="field">
        <div class="control">
          <input id="githubUsername" type="text" class="input" placeholder="Type your GitHub username">
        </div>
      </div>
      <p class="panel-heading">
        GitHub Sync Interval
      </p>
      <div class="field">
        <div class="control">
          <input id="githubSyncInterval" type="number" class="input" placeholder="15">
          <span class="input-text">Minutes</span>
        </div>
      </div>
      <p class="panel-heading">
        Launch at login
        <label class="checkbox is-pulled-right">
          <input id="launchAtLoginCheckbox" type="checkbox">
          Enable
        </label>
      </p>
      <p class="panel-heading">
        Notifications
        <label class="checkbox is-pulled-right">
          <input id="notificationCheckbox" type="checkbox">
          Enable
        </label>
      </p>
      <div class="field">
        <div class="control">
          <input id="notificationHour" type="number" class="input" placeholder="hh" min="0" max="23" maxlength="2">
          <span class="input-text"> : </span>
          <input id="notificationMinutes" type="number" class="input" placeholder="mm" min="0" max="59" maxlength="2">
        </div>
      </div>
    </nav>

  </main>

  <script>

    const { ipcRenderer } = require('electron');

    const store = require('./store');

    const githubUsername = document.getElementById('githubUsername');
    const githubSyncInterval = document.getElementById('githubSyncInterval');
    const launchAtLoginCheckbox = document.getElementById('launchAtLoginCheckbox');
    const notificationCheckbox = document.getElementById('notificationCheckbox');
    const notificationHour = document.getElementById('notificationHour');
    const notificationMinutes = document.getElementById('notificationMinutes');

    let typingTimer;

    githubUsername.value = store.get('username') || '';
    githubSyncInterval.value = store.get('syncInterval') || '';
    notificationHour.value = store.get('notification.hours') || '';
    notificationMinutes.value = store.get('notification.minutes') || '';

    if (githubUsername.value === '') {
      githubUsername.focus();
      githubUsername.classList.add('is-warning');
    }

    if (store.get('autoLaunch')) {
      launchAtLoginCheckbox.checked = true;
    }

    if (!store.get('notification.isEnabled')) {
      notificationHour.disabled = true;
      notificationMinutes.disabled = true;
    } else {
      notificationCheckbox.checked = true;
    }

    if (notificationMinutes.value === '' || notificationMinutes.value === '0') {
      notificationMinutes.value = '00';
    }

    githubUsername.addEventListener('keyup', () => {
      clearTimeout(typingTimer);
      if(isInputEmpty(githubUsername)) {
        return;
      }
      githubUsername.parentElement.classList.add('is-loading');
      typingTimer = setTimeout(() => {
        ipcRenderer.send('setUsername', githubUsername.value);
      }, 1000);
    })

    githubUsername.addEventListener('keydown', () => {
      clearTimeout(typingTimer);
    })

    githubSyncInterval.addEventListener('keyup', () => {
      if (isInputEmpty(githubSyncInterval)) {
        return;
      }
      const syncInterval = parseInt(githubSyncInterval.value, 10);
      ipcRenderer.send('setSyncInterval', syncInterval);
    })

    launchAtLoginCheckbox.addEventListener('change', (event) => {
      ipcRenderer.send('activateLaunchAtLogin', launchAtLoginCheckbox.checked);
    })

    notificationCheckbox.addEventListener('change', (event) => {
      if (notificationCheckbox.checked) {
        notificationHour.disabled = false;
        notificationMinutes.disabled = false;
        isInputEmpty(notificationHour);
        isInputEmpty(notificationMinutes);
        ipcRenderer.send('activateNotifications', notificationCheckbox.checked);
      } else {
        notificationHour.disabled = true;
        notificationMinutes.disabled = true;
        notificationHour.classList.remove('is-warning');
        notificationMinutes.classList.remove('is-warning');
        ipcRenderer.send('activateNotifications', notificationCheckbox.checked);
      }
    })

    notificationHour.addEventListener('keyup', () => {
      if (isInputEmpty(notificationHour)) {
        return;
      }
      const hours = parseInt(notificationHour.value, 10);
      if(hours >= 0 && hours <= 23) {
        ipcRenderer.send('setNotificationTime', {
          hours: hours,
          minutes: store.get('notification.minutes')
        });
      } else {
        notificationHour.classList.add('is-warning');
      }
    })

    notificationMinutes.addEventListener('keyup', () => {
      if (isInputEmpty(notificationMinutes)) {
        return;
      }
      const minutes = parseInt(notificationMinutes.value, 10);
      if (minutes >= 0 && minutes <= 59) {
        ipcRenderer.send('setNotificationTime', {
          hours: store.get('notification.hours'),
          minutes: minutes
        });
      } else {
        notificationMinutes.classList.add('is-warning');
      }
    })

    ipcRenderer.on('usernameSet', () => {
      console.log('usernameSet : ', store.get('username'));
      githubUsername.parentElement.classList.remove('is-loading');
    });

    ipcRenderer.on('syncIntervalSet', () => {
      console.log('syncInterval : ', store.get('syncInterval'));
    })

    ipcRenderer.on('activateLaunchAtLoginSet', () => {
      console.log('autoLaunch : ', store.get('autoLaunch'));
    })

    ipcRenderer.on('activateNotificationsSet', () => {
      console.log('Notification state : ', store.get('notification.isEnabled'));
    })

    ipcRenderer.on('NotificationTimeSet', () => {
      console.log('NotificationTimeSet : ', store.get('notification.time'));
    })

    function isInputEmpty(element) {
      if (element.value === '') {
        element.classList.add('is-warning');
        return true;
      } else {
        element.classList.remove('is-warning');
        return false;
      }
    }

  </script>
</body>

</html>